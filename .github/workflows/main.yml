name: OpenAI PR Reviewer

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openai requests

      - name: Review PR with OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - <<EOF
          import openai
          import os
          import requests

          # Configuration
          openai.api_key = os.getenv("OPENAI_API_KEY")
          pr_number = os.getenv("GITHUB_REF").split('/')[-2]
          repo_name = os.getenv("GITHUB_REPOSITORY")
          token = os.getenv("GITHUB_TOKEN")

          # Fetch PR diff
          headers = {"Authorization": f"token {token}"}
          diff_url = f"https://api.github.com/repos/{repo_name}/pulls/{pr_number}"
          pr_diff = requests.get(diff_url, headers=headers).json()["diff"]

          # Send PR diff to OpenAI
          response = openai.ChatCompletion.create(
              model="gpt-4",
              messages=[
                  {"role": "system", "content": "You are a code reviewer."},
                  {"role": "user", "content": pr_diff}
              ]
          )

          # Post a comment on the PR
          review_comment = response['choices'][0]['message']['content']
          comment_url = f"https://api.github.com/repos/{repo_name}/issues/{pr_number}/comments"
          requests.post(comment_url, headers=headers, json={"body": review_comment})
          EOF
